{% load static %}
<script type="text/javascript">
if (typeof jQuery == 'undefined') {
  document.write('<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"\n' +
    '  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="\n' +
    '  crossorigin="anonymous"><\/script>');
  }
</script>
    <button id="onboard">Loading...</button>
  <script src="{% static 'metamask/js/metamask-onboarding.bundle.js' %}"></script>
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const onboarding = new MetaMaskOnboarding();
        const onboardButton = document.getElementById('onboard');
        let accounts;

        const updateButton = () => {
          if (!MetaMaskOnboarding.isMetaMaskInstalled()) {
            onboardButton.innerText = 'Click here to install MetaMask!';
            onboardButton.onclick = () => {
              onboardButton.innerText = 'Onboarding in progress';
              onboardButton.disabled = true;
              onboarding.startOnboarding();
            };
          } else if (accounts && accounts.length > 0) {
            onboardButton.innerText = 'Connected';
            onboardButton.disabled = true;
            const account = accounts[0];
            $.ajax({
                url : "/accounts/metamask/login/",
                type : "POST",
                dataType: 'json',
                headers:{
                "X-CSRFToken": '{{ csrf_token }}'
                 },
                data : JSON.stringify({
                    username: account,
                    account: account,
                    accounts : accounts,
                    next : next,
                    process: process,
                })
            }).done(function(data) {
                if (data == "fine") {
                    window.location = window.location;
                }
            });
            onboarding.stopOnboarding();
          } else {
            onboardButton.innerText = 'Connect';
            onboardButton.onclick = async () => {
              await window.ethereum.request({
                method: 'eth_requestAccounts',
              });
            };
          }
        };

        updateButton();
        if (MetaMaskOnboarding.isMetaMaskInstalled()) {
          window.ethereum.on('accountsChanged', (newAccounts) => {
            accounts = newAccounts;
            updateButton();
          });
        }
      });
    </script>
